From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Jason Penilla <11360596+jpenilla@users.noreply.github.com>
Date: Tue, 21 May 2024 13:18:00 -0700
Subject: [PATCH] Allow Bukkit plugin to use Paper PluginLoader API


diff --git a/src/main/java/org/bukkit/plugin/PluginDescriptionFile.java b/src/main/java/org/bukkit/plugin/PluginDescriptionFile.java
index c0691a849831f99268fdcb7b0f471f80a1a2a70e..95df45f4042f80f25e923c2a170a79906212f459 100644
--- a/src/main/java/org/bukkit/plugin/PluginDescriptionFile.java
+++ b/src/main/java/org/bukkit/plugin/PluginDescriptionFile.java
@@ -259,6 +259,13 @@ public final class PluginDescriptionFile implements io.papermc.paper.plugin.conf
     private Set<PluginAwareness> awareness = ImmutableSet.of();
     private String apiVersion = null;
     private List<String> libraries = ImmutableList.of();
+    // Paper start - plugin loader api
+    private String paperPluginLoader;
+    @org.jetbrains.annotations.ApiStatus.Internal @org.jetbrains.annotations.Nullable
+    public String getPaperPluginLoader() {
+        return this.paperPluginLoader;
+    }
+    // Paper end - plugin loader api
     // Paper start - oh my goddddd
     /**
      * Don't use this.
@@ -1232,6 +1239,7 @@ public final class PluginDescriptionFile implements io.papermc.paper.plugin.conf
         } else {
             libraries = ImmutableList.<String>of();
         }
+        if (map.containsKey("paper-plugin-loader")) this.paperPluginLoader = map.get("paper-plugin-loader").toString(); // Paper - plugin loader api
 
         try {
             lazyPermissions = (Map<?, ?>) map.get("permissions");
diff --git a/src/main/java/org/bukkit/plugin/java/LibraryLoader.java b/src/main/java/org/bukkit/plugin/java/LibraryLoader.java
index 8e1b6be2462aaa692efa1f72986921a6dc357196..fb0a6fb6c1b7dfdbc567cb250535479537a2cfbb 100644
--- a/src/main/java/org/bukkit/plugin/java/LibraryLoader.java
+++ b/src/main/java/org/bukkit/plugin/java/LibraryLoader.java
@@ -84,7 +84,13 @@ public class LibraryLoader
     @Nullable
     public ClassLoader createLoader(@NotNull PluginDescriptionFile desc)
     {
-        if ( desc.getLibraries().isEmpty() )
+        // Paper start - plugin loader api
+        return this.createLoader(desc, null);
+    }
+    @Nullable
+    public ClassLoader createLoader(@NotNull PluginDescriptionFile desc, java.nio.file.Path @Nullable [] paperLibraryPaths) {
+        if ( desc.getLibraries().isEmpty() && paperLibraryPaths == null )
+        // Paper end - plugin loader api
         {
             return null;
         }
@@ -103,17 +109,20 @@ public class LibraryLoader
         }
 
         DependencyResult result;
-        try
+        if (!dependencies.isEmpty()) try // Paper - plugin loader api
         {
             result = repository.resolveDependencies( session, new DependencyRequest( new CollectRequest( (Dependency) null, dependencies, repositories ), null ) );
         } catch ( DependencyResolutionException ex )
         {
             throw new RuntimeException( "Error resolving libraries", ex );
-        }
+        } else result = null; // Paper - plugin loader api
 
         List<URL> jarFiles = new ArrayList<>();
         List<java.nio.file.Path> jarPaths = new ArrayList<>(); // Paper - remap libraries
-        for ( ArtifactResult artifact : result.getArtifactResults() )
+        // Paper start - plugin loader api
+        if (paperLibraryPaths != null) jarPaths.addAll(Arrays.asList(paperLibraryPaths));
+        if (result != null) for ( ArtifactResult artifact : result.getArtifactResults() )
+        // Paper end - plugin loader api
         {
             // Paper start - remap libraries
             jarPaths.add(artifact.getArtifact().getFile().toPath());
